include:
  - docker/docker-compose/compose.build.yaml
  - docker/docker-compose/compose.config.yaml
  - docker/docker-compose/compose.services.yaml

services:
  # === PROD PROFILE ===
  nginx:
    build:
      context: ./configuration/nginx
      target: prod
    container_name: nginx
    ports:
      - "80:80"
    depends_on:
      - vuejs
      - nextjs
    profiles: [ "prod" ]
    networks:
      - external-network

  vuejs:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: prod
    container_name: vuejs_app
    ports:
      - "8080:80"
    restart: always
    profiles: [ "prod" ]

  nextjs:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: prod
    container_name: nextjs_app
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
    restart: always
    profiles: [ "prod" ]

  # === DEV PROFILE ===

  nginx-dev:
    build:
      context: ./configuration/nginx
      target: dev
    container_name: nginx_dev
    ports:
      - "80:80"
    depends_on:
      - vuejs-dev
      - nextjs-dev
    profiles: [ "dev" ]
    networks:
      - external-network

  vuejs-dev:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: dev
    container_name: vuejs_dev
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      NODE_ENV: development
    profiles: [ "dev" ]
    networks:
      - external-network

  nextjs-dev:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: dev
    container_name: nextjs_dev
    ports:
      - "3000:3000"
    volumes:
      - ./backend:/app
      - /app/node_modules
    environment:
      NODE_ENV: development
      NEXT_WATCH_MODE: poll
      NEXT_WATCH_POLL_INTERVAL: 1000
      RABBIT_HOST: ${RABBIT_HOST}
      RABBIT_PORT: ${RABBIT_PORT}
      RABBIT_USER: ${RABBIT_USER}
      RABBIT_PASS: ${RABBIT_PASS}
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_USER}
      MINIO_SECRET_KEY: ${MINIO_PASSWORD}
      POSTGRES_HOST: postgres
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASS}
      POSTGRES_DB: ${POSTGRES_DB:-appdb}
    profiles: [ "dev" ]
    networks:
      - external-network
      - internal-network

  # === PIPE SERVICES ===
  transcription-manager:
    image: pipe-manager:latest
    container_name: transcription-manager
    environment:
      RABBIT_HOST: ${RABBIT_HOST}
      RABBIT_PORT: ${RABBIT_PORT}
      RABBIT_USER: ${RABBIT_USER}
      RABBIT_PASS: ${RABBIT_PASS}
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_USER}
      MINIO_SECRET_KEY: ${MINIO_PASSWORD}
      DOCKER_HOST: unix:///var/run/docker.sock
    depends_on:
      rabbitmq:
        condition: service_healthy
      minio:
        condition: service_healthy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./Pipes/Subtitles/manager.py:/app/manager.py:ro
    working_dir: /app

  resolution-manager:
    image: pipe-manager:latest
    container_name: resolution-manager
    environment:
      RABBIT_HOST: rabbitmq
      RABBIT_PORT: 5672
      RABBIT_USER: admin
      RABBIT_PASS: admin
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      DOCKER_HOST: unix:///var/run/docker.sock
    depends_on:
      rabbitmq:
        condition: service_healthy
      minio:
        condition: service_healthy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./Pipes/Resolution/manager.py:/app/manager.py:ro
    working_dir: /app